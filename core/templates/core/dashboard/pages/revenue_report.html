{% extends "core/dashboard/base.html" %}
{% load static %}
{% load humanize %}
{% block title %}
  {{ title|default:"Revenue Report" }}
{% endblock title %}
{% block admincontent %}
  <div class="p-4 border-2 border-gray-200 border-dashed rounded-lg dark:border-gray-700 mt-14">
    <div class="border-2 border-gray-200 rounded-lg dark:border-gray-700">
      <h1 class="p-4 text-2xl font-semibold text-gray-900 dark:text-white mb-2"></h1>
      {% if messages %}
        <div class="mb-6 px-4">
          {% for message in messages %}
            <div class="p-4 rounded {% if message.tags == 'error' %} bg-red-100 border border-red-400 text-red-700 dark:bg-red-900 dark:border-red-700 dark:text-red-200 {% elif message.tags == 'success' %} bg-green-100 border border-green-400 text-green-700 dark:bg-green-900 dark:border-green-700 dark:text-green-200 {% elif message.tags == 'warning' %} bg-yellow-100 border border-yellow-400 text-yellow-700 dark:bg-yellow-900 dark:border-yellow-700 dark:text-yellow-200 {% else %} bg-blue-100 border border-blue-400 text-blue-700 dark:bg-blue-900 dark:border-blue-700 dark:text-blue-200 {% endif %}"
                 role="alert">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
      <div class="flex items-center justify-between flex-column md:flex-row flex-wrap space-y-4 md:space-y-0 py-4 bg-white dark:bg-gray-900 px-4">
        {# Export Button #}
        <a href="{% url 'export_revenue_report_excel' %}{{ request.GET.urlencode }}"
           id="export-excel-button"
           class="text-white bg-green-500 hover:bg-green-800 focus:ring-4 focus:outline-none focus:ring-green-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center inline-flex items-center dark:bg-green-600 dark:hover:bg-green-700 dark:focus:ring-green-800">
          ດາວໂຫຼດ Excel
        </a>
        {# Filter Form #}
        <form method="get"
              action="{% url 'revenue_report' %}"
              class="md:flex md:items-end md:space-x-4 space-y-4 md:space-y-0">
          <div>
            <label for="year_filter"
                   class="block mb-1 text-sm font-medium text-gray-900 dark:text-white">ປີ</label>
            <select id="year_filter"
                    name="year"
                    class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
              {% for year_val in year_choices %}
                <option value="{{ year_val }}"
                        {% if year_val == selected_year %}selected{% endif %}>{{ year_val }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label for="month_filter"
                   class="block mb-1 text-sm font-medium text-gray-900 dark:text-white">ເດືອນ</label>
            <select id="month_filter"
                    name="month"
                    class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
              <option value="">All Months</option>
              {% for month_val in month_choices %}
                <option value="{{ month_val }}"
                        {% if month_val|stringformat:"s" == selected_month|stringformat:"s" %}selected{% endif %}>
                  {% if month_val == 1 %}
                    ມັງກອນ
                  {% elif month_val == 2 %}
                    ກຸມພາ
                  {% elif month_val == 3 %}
                    ມີນາ
                  {% elif month_val == 4 %}
                    ເມສາ
                  {% elif month_val == 5 %}
                    ພຶດສະພາ
                  {% elif month_val == 6 %}
                    ມິຖຸນາ
                  {% elif month_val == 7 %}
                    ກໍລະກົດ
                  {% elif month_val == 8 %}
                    ສິງຫາ
                  {% elif month_val == 9 %}
                    ກັນຍາ
                  {% elif month_val == 10 %}
                    ຕຸລາ
                  {% elif month_val == 11 %}
                    ພະຈິກ
                  {% elif month_val == 12 %}
                    ທັນວາ
                  {% endif %}
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="flex items-end space-x-2">
            <button type="submit"
                    class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 dark:bg-blue-600 dark:hover:bg-blue-700 focus:outline-none dark:focus:ring-blue-800">
              ກອງຂໍ້ມູນ
            </button>
            <a href="{% url 'revenue_report' %}"
               class="py-2.5 px-5 text-sm font-medium text-gray-900 focus:outline-none bg-white rounded-lg border border-gray-200 hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-4 focus:ring-gray-100 dark:focus:ring-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600 dark:hover:text-white dark:hover:bg-gray-700">
              ລ້າງຕົວກອງ
            </a>
          </div>
        </form>
      </div>
      {# Total Revenue Display #}
      <div class="px-4 py-3 bg-gray-50 dark:bg-gray-800 border-t border-b dark:border-gray-700">
        <p class="text-lg font-semibold text-gray-800 dark:text-white">
          ລາຍຮັບລວມ (ທີ່ກອງ): LAK {{ total_revenue|floatformat:2|intcomma }}
        </p>
      </div>
      {# Payments Table #}
      <div class="relative overflow-x-auto shadow-md sm:rounded-b-lg">
        <table class="w-full text-sm text-left rtl:text-right text-gray-500 dark:text-gray-400">
          <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
            <tr class="lao-table-header">
              <th scope="col" class="px-6 py-3">ວັນທີ່ຊຳລະ</th>
              <th scope="col" class="px-6 py-3">ລະຫັດການເຊົ່າ</th>
              <th scope="col" class="px-6 py-3">ລູກຄ້າ</th>
              <th scope="col" class="px-6 py-3">ຈຳນວນເງິນ</th>
              <th scope="col" class="px-6 py-3">ປະເພດການຊຳລະ</th>
              <th scope="col" class="px-6 py-3">ວິທີການຊຳລະ</th>
              <th scope="col" class="px-6 py-3">ໝາຍເຫດ</th>
            </tr>
          </thead>
          <tbody>
            {% for payment in payments %}
              <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                <td class="px-6 py-4 whitespace-nowrap">{{ payment.transaction_date|date:"Y-m-d H:i" }}</td>
                <td class="px-6 py-4">
                  {% if payment.rental %}
                    <a href="{% url 'manage_rental_transactions' %}?customer={{ payment.rental.customer.user.email }}"
                       class="text-blue-600 hover:underline">#{{ payment.rental.id }}</a>
                  {% else %}
                    N/A
                  {% endif %}
                </td>
                <td class="px-6 py-4">
                  {% if payment.rental and payment.rental.customer %}
                    {{ payment.rental.customer.get_full_name }}
                    <span class="block text-xs">{{ payment.rental.customer.user.email }}</span>
                  {% else %}
                    N/A
                  {% endif %}
                </td>
                <td class="px-6 py-4">LAK {{ payment.amount|floatformat:2|intcomma }}</td>
                <td class="px-6 py-4">{{ payment.get_payment_type_display }}</td>
                <td class="px-6 py-4">{{ payment.get_payment_method_display }}</td>
                <td class="px-6 py-4 text-xs">{{ payment.notes|truncatewords:10 }}</td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="7"
                    class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">
                  ບໍ່ພົບຂໍ້ມູນການຊຳລະສຳລັບໄລຍະເວລາທີ່ເລືອກ.
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {# Pagination #}
    {% include "core/dashboard/partials/pagination.html" with page_obj=payments %}
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const exportButton = document.getElementById('export-excel-button');
      if (exportButton) {
        // Update the export button's href to include current GET parameters
        // This ensures filters are applied to the export
        const currentParams = new URLSearchParams(window.location.search);
        exportButton.href = "{% url 'export_revenue_report_excel' %}" + (currentParams.toString() ? '?' + currentParams.toString() : '');
      }
    });
  </script>
{% endblock admincontent %}
